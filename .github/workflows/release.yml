# yamllint disable rule:document-start
# yamllint disable rule:truthy
name: Release
on:
  push:
    tags:
      - "v*"
permissions:
  contents: write
jobs:
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools-runner:v0.2.1
      options: --user 1001
    env:
      FULMEN_WORKSPACE_ROOT: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Validate VERSION matches tag
        shell: bash
        run: |
          set -euo pipefail
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            MSG="VERSION ($FILE_VERSION) != tag ($TAG_VERSION)"
            echo "::error::$MSG"
            exit 1
          fi
      - name: Verify toolchain
        shell: bash
        run: |
          set -euo pipefail
          goneat --version
          sfetch --version
          go version
          go mod download
      - name: Lint
        shell: bash
        run: |
          set -euo pipefail
          make lint
      - name: Test
        shell: bash
        run: |
          set -euo pipefail
          make test
      - name: Build release artifacts
        shell: bash
        run: |
          set -euo pipefail
          make release-build
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/release/*
