name: CI
on:
  push:
    branches: [main]
  pull_request:
permissions:
  contents: read

jobs:
  # Container-based format checking (LOW friction - v0.3.14+)
  # Uses goneat-tools container which has all foundation tools pre-installed
  format-check:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:latest
      # REQUIRED: actions/checkout@v4 needs write access to /__w/_temp/_runner_file_commands/
      # See: docs/development/ci.md for details on container permissions
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Fix temp permissions
        run: |
          set -euo pipefail
          sudo install -d -m 0777 /__w/_temp || true
          sudo install -d -m 0777 /__w/_temp/_runner_file_commands || true
          sudo chown -R $(id -u):$(id -g) /__w/_temp || true
          sudo chmod -R 777 /__w/_temp || true
      - name: Verify foundation tools
        run: |
          set -euo pipefail
          prettier --version
          yamlfmt --version
          jq --version
          yq --version
          rg --version
      - name: Check formatting
        run: |
          set -euo pipefail
          yamlfmt -lint .
          prettier --check "**/*.{md,json}" || echo "Prettier differences found (non-blocking)"

  # Build and test using goneat-tools container (LOW friction - all tools available)
  # Container provides foundation tools; we install goneat binary separately
  build-test:
    needs: [format-check]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:latest
      # REQUIRED: actions/checkout@v4 needs write access to /__w/_temp/_runner_file_commands/
      # See: docs/development/ci.md for details on container permissions
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Fix temp permissions
        run: |
          set -euo pipefail
          sudo install -d -m 0777 /__w/_temp || true
          sudo install -d -m 0777 /__w/_temp/_runner_file_commands || true
          sudo chown -R $(id -u):$(id -g) /__w/_temp || true
          sudo chmod -R 777 /__w/_temp || true
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Install goneat binary
        run: |
          set -euo pipefail
          ./scripts/install-goneat.sh
          go mod download
      - name: Verify foundation tools available
        run: |
          set -euo pipefail
          echo "=== Foundation tools from container ==="
          prettier --version
          yamlfmt --version
          echo "=== Goneat installed ==="
          ./bin/goneat --version
      - name: Format (using goneat - fail on diff)
        run: |
          set -euo pipefail
          make fmt
          git diff --exit-code
      - name: Install golangci-lint (v2)
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
          args: --help
      - name: Lint
        run: |
          set -euo pipefail
          make lint
      - name: Test
        run: |
          set -euo pipefail
          make test
      - name: Build binary
        run: |
          set -euo pipefail
          make build
