name: CI
on:
  push:
    branches: [main]
  pull_request:
jobs:
  # Container-based format checking (LOW friction - v0.3.14+)
  format-check:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Verify foundation tools
        run: |
          prettier --version
          yamlfmt --version
          jq --version
          yq --version
          rg --version
      - name: Check formatting
        run: |
          yamlfmt -lint .
          prettier --check "**/*.{md,json}" || echo "Prettier differences found (non-blocking)"

  # Build and test (depends on format-check passing)
  build-test:
    needs: [format-check]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Bootstrap tools (goneat doctor handles package managers)
        run: |
          make bootstrap
          ./bin/goneat doctor tools env --github >> $GITHUB_PATH
      - name: Format Go code (fail on diff)
        run: |
          make fmt
          git diff --exit-code
      - name: Install golangci-lint (v2)
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
          # Don't run linting here - just install. We run via make lint below.
          args: --help
      - name: Lint
        run: make lint
      - name: Test
        run: make test
