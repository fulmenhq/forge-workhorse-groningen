# yamllint disable rule:document-start
# yamllint disable rule:truthy
name: CI
on:
  push:
    branches: [main]
  pull_request:
permissions:
  contents: read
jobs:
  # Container-based format checking (LOW friction - v0.3.14+)
  # Uses goneat-tools container which has all foundation tools pre-installed
  format-check:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:v0.1.5
      # goneat-tools runs as a non-root user by default.
      # Use UID 1001 to match GitHub-hosted runner workspace ownership.
      options: --user 1001
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Verify foundation tools
        run: |
          set -euo pipefail
          prettier --version
          yamlfmt --version
          jq --version
          yq --version
          rg --version
      - name: Check formatting
        run: |
          set -euo pipefail
          yamlfmt -lint .
          prettier --check "**/*.{md,json}" || \
            echo "Prettier differences found (non-blocking)"
  # Build and test using goneat-tools container
  # Container provides foundation tools; we install goneat separately
  # Container provides foundation tools; we install goneat binary separately
  build-test:
    needs: [format-check]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools:v0.1.5
      # goneat-tools runs as a non-root user by default.
      # Use UID 1001 to match GitHub-hosted runner workspace ownership.
      options: --user 1001
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Install sfetch + goneat
        run: |
          set -euo pipefail
          BIN_DIR="$HOME/.local/bin"
          mkdir -p "$BIN_DIR"
          SFETCH_INSTALL_URL="https://github.com/3leaps/sfetch/releases/latest/download/"
          SFETCH_INSTALL_URL="${SFETCH_INSTALL_URL}install-sfetch.sh"
          curl -sSfL "$SFETCH_INSTALL_URL" | bash -s -- --yes --dir "$BIN_DIR"
          export PATH="$BIN_DIR:$PATH"
          sfetch --self-verify
          sfetch --repo fulmenhq/goneat --tag v0.3.16 \
            --dest-dir "$BIN_DIR"
          if [ -f "$BIN_DIR/goneat.exe" ] && \
            [ ! -f "$BIN_DIR/goneat" ]; then
            mv "$BIN_DIR/goneat.exe" "$BIN_DIR/goneat"
          fi
          goneat --version
          go mod download
      - name: Verify foundation tools available
        run: |
          set -euo pipefail
          echo "=== Foundation tools from container ==="
          prettier --version
          yamlfmt --version
          echo "=== Goneat installed ==="
          goneat --version
      - name: Format (using goneat - fail on diff)
        run: |
          set -euo pipefail
          make fmt
          git diff --exit-code
      - name: Install golangci-lint (v2)
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.4.0
          args: --help
      - name: Lint
        run: |
          set -euo pipefail
          make lint
      - name: Test
        run: |
          set -euo pipefail
          make test
      - name: Build binary
        run: |
          set -euo pipefail
          make build
